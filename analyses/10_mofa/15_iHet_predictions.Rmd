---
title: "Analysis of iHet predictions"
params:
    repo_dir: "../../../../repo_pred/iHet_predictions"
    folderValidation: "../../../../../iHet/Validation/prediction_files/"
    zipMOFAmodels: "../../../../../iHet/iHet_data/MOFA_noDCandMono/MOFA_out.zip"
    TCGAbootstrapFeatureStats: "../../../../repo_pred/iHet_predictions/data/TCGA_bootstrap_features_stats.rds"
    weightsTCGAMOFA: "../../../../repo_pred/iHet_predictions/data/all_tcga_iHet_weights_bootstrap_noDCandMono_scaled.RDS"
    dataBagaevMFP: "../../../../repo_pred/iHet_predictions/data/immune_subtypes/bagaev_mfp_tcga.xlsx"
    dataTCGAfeatures: "../../../../iHet_data/features/TCGA_expr_data.features.rds"
    dataCorHIF: "../../../../repo_pred/iHet_predictions/data/correlation_features_fibroblasts_all_tissues.RDS"
    dataTCGAiHet: "../../../../repo_pred/iHet_predictions/data/tcga_ihet_scores/all_tcga_iHet_scores_using_scaled_weights.RDS"
    folderValidationiHet: "../../../../repo_pred/iHet_predictions/analysis/iHet_ms/"
    dataImmscoreZ: "../../../../repo_FFGS/iHet/tables/easier_Zscores/immscoreZ.rds"

---

## Load input data

```{r setup, include = FALSE}

# paths #
repo_dir <- params$repo_dir
zipMOFAmodels <- params$zipMOFAmodels
TCGAbootstrapFeatureStats <- params$TCGAbootstrapFeatureStats
folderValidation <- params$folderValidation
folderValidationiHet <- params$folderValidationiHet

# utils #
source("./helper_iHet_predictions.R")

# Read TCGA MOFA bootstrap weights (scaled) #
df_tcga_weights <- readRDS(file = params$weightsTCGAMOFA)
df_tcga_weights_median <- aggregate(df_tcga_weights,
                                    weight ~ feature + factor + view + cancertype, 
                                    FUN = "median")

# Read Bagaev molecular subtypes for TCGA data #
Bagaev_mfp <- readxl::read_xlsx(params$dataBagaevMFP, sheet = 2)
colnames(Bagaev_mfp) <- Bagaev_mfp[1,]
Bagaev_mfp <- Bagaev_mfp[-1,]
model = c("BLCA", "BRCA", "CESC","CRC", "GBM", "HNSC", "KIRC", "KIRP", 
          "LIHC", "OV", "PAAD", "PRAD", "SKCM", "STAD", "THCA", "UCEC", 
          "LUAD", "LUSC", "NSCLC")

Bagaev_mfp$TCGA_project <- gsub("COAD", "CRC", Bagaev_mfp$TCGA_project)
Bagaev_mfp$TCGA_project <- gsub("READ", "CRC", Bagaev_mfp$TCGA_project)

Bagaev_mfp <- subset(Bagaev_mfp, TCGA_project %in% model)
colnames(Bagaev_mfp)[1] <- "patient"
Bagaev_mfp <- Bagaev_mfp %>% select(patient, "MFP", "PFS", "TMB")

# Read TCGA features data #
all_tcga <- readRDS(params$dataTCGAfeatures)

# Read information about features correlated with density of fibroblasts in tumor region #
feat_cor_hifs <- readRDS(params$dataCorHIF)

# Read TCGA iHet scores #
tcga_iHet_scores <- readRDS(file = params$dataTCGAiHet)
tcga_iHet_scores_median <- aggregate(tcga_iHet_scores, 
                              score ~ method + model + pat_id, 
                              FUN = "median")

# Tasks: Immune response scores #
all_tcga[["immresp"]][["NSCLC"]] <- rbind(all_tcga[["immresp"]][["LUAD"]], all_tcga[["immresp"]][["LUSC"]])
IR <- all_tcga[["immresp"]]

# Immune response z-score #
immscoreZ <- readRDS(params$dataImmscoreZ)

## Remember to save svg files using svglite() ##

```

## Compute iHet for TCGA patients

```{r}

# cancer types
model = c("BLCA", "BRCA", "CESC","CRC", "GBM", "HNSC", "KIRC", "KIRP",
          "LIHC", "LUAD", "LUSC", "NSCLC", "OV", "PAAD", "PRAD",
          "SKCM", "STAD", "THCA", "UCEC")

# Compute iHet for each cancer type
for (model_sel in model){
  
  if (model_sel == "NSCLC"){
    # NSCLC TCGA data
    all_tcga$count$NSCLC <- cbind(all_tcga$count$LUAD, all_tcga$count$LUSC)
    all_tcga$tpm$NSCLC <- cbind(all_tcga$tpm$LUAD, all_tcga$tpm$LUSC)
  }

  counts <- solve_annotation_issues(gene_expr = all_tcga$count[[model_sel]])
  tpm <- solve_annotation_issues(gene_expr = all_tcga$tpm[[model_sel]])

  all_dataset <- list(counts = counts,
                      tpm = tpm)

  iHet_df <- compute_iHet(dataset = all_dataset,
                          model = model_sel,
                          use_bootstrap_weights=TRUE,
                          method = c("iHet", "iHet_inverted", "iHet_exclusion"),
                          use_fibroblasts_hifs_tissue = "tumor",
                          cancer_type_hifs = "NSCLC",
                          assess_cor_threshold = FALSE,
                          scaled = TRUE)

  if (model_sel != "NSCLC") iHet_df$model <- model_sel
  saveRDS(iHet_df, file = paste0(repo_dir, "/data/tcga_ihet_scores/", model_sel, "_iHet_scores_using_scaled_weights.RDS"))
}

# Re-format iHet data.frame
tcga_iHet_scores <- do.call(rbind, lapply(model[!model %in% c("NSCLC")], function(XX){

  print(XX)
  tmp <- readRDS(file = paste0(repo_dir, "/data/tcga_ihet_scores/", XX, "_iHet_scores_using_scaled_weights.RDS"))
  colnames(tmp) <- c("patient", "score", "hif_tissue", "method","run", "model")

  return(tmp)
}))

colnames(tcga_iHet_scores)[1] <- "pat_id"
tcga_iHet_scores$pat_id <- gsub(".", "-", tcga_iHet_scores$pat_id, fixed = TRUE)
tcga_iHet_scores$pat_id <- substr(tcga_iHet_scores$pat_id, 1, 12)
#saveRDS(tcga_iHet_scores, file = paste0(repo_dir, "/data/tcga_ihet_scores/all_tcga_iHet_scores_using_scaled_weights.RDS"))

# Retrieve iHet score TCGA-NSCLC patients
iHet_df <- readRDS(file = paste0(repo_dir, "/data/tcga_ihet_scores/NSCLC_iHet_scores_using_scaled_weights.RDS"))
colnames(iHet_df)[1] <- "pat_id"
iHet_df$pat_id <- gsub(".", "-", iHet_df$pat_id, fixed = TRUE)
iHet_df$pat_id <- substr(iHet_df$pat_id, 1, 12)
luad_patients <- substr(gsub(".", "-", colnames(all_tcga$tpm$LUAD), fixed = TRUE), 1, 12)
lusc_patients <- substr(gsub(".", "-", colnames(all_tcga$tpm$LUSC), fixed = TRUE), 1, 12)

## LUAD
iHet_df_luad <- iHet_df %>% filter(model == "LUAD" & pat_id %in% luad_patients)

## LUSC
iHet_df_lusc <- iHet_df %>% 
  filter(model == "LUSC" & pat_id %in% lusc_patients)
iHet_df <- rbind(iHet_df_luad, iHet_df_lusc)
iHet_df$model <- "NSCLC"
tcga_iHet_scores <- rbind(tcga_iHet_scores, iHet_df)

#saveRDS(tcga_iHet_scores, file = paste0(repo_dir, "/data/tcga_ihet_scores/all_tcga_iHet_scores_using_scaled_weights.RDS"))

# Compute median iHet (one value per patient)
tcga_iHet_scores_median <- aggregate(tcga_iHet_scores, 
                                     score ~ method + model + pat_id, 
                                     FUN = "median")

# Save iHet scores matrix
tcga_iHet_mat <- tcga_iHet_scores_median %>% 
  pivot_wider(names_from = method, values_from = score)
colnames(tcga_iHet_mat)[5] <- "iHet_rev"
#saveRDS(object = tcga_iHet_mat, file = paste0("./iHet_ms/tcga_unified_iHet_scores.RDS"))

# iHet features median weights for NSCLC (Supplementary table 2)

## get weights
iHet_median_weights_tcga_NSCLC <- get_iHet_associated_weights(use_bootstrap_weights = FALSE, 
                                                              model = "NSCLC",
                                                              use_fibroblasts_hifs_tissue = "tumor",
                                                              cancer_type_hifs = "NSCLC",
                                                              scale_mofa_weights = TRUE)

## write into .csv file
write.csv(iHet_median_weights_tcga_NSCLC, 
          file = paste0(repo_dir, "../../../../SupplementaryTable2.csv"),
          col.names = TRUE, row.names = FALSE)


## Check number of patients per cancer type TCGA
tcga_iHet_scores_median %>% filter(method=="iHet") %>% group_by(model, method) %>% dplyr::summarise(count=n())

```

## Examine TCGA-NSCLC features across microenvironment subtypes (Bagaev et al.)

```{r}

# Keep descriptors used as input for MOFA
all_tcga <- all_tcga[c("pathway", "tf", "cellfrac")]
cancer_types <- names(all_tcga$pathway)

# Normalize scores as in MOFA

## Pathways
tmp_path <- lapply(cancer_types, function(X) scale(all_tcga$pathway[[X]]))
all_tcga$pathway <- tmp_path; names(all_tcga$pathway) <- cancer_types
all_tcga$pathway$NSCLC <-  rbind(all_tcga$pathway$LUAD, all_tcga$pathway$LUSC)

## Cell fractions
tmp_cellfrac <- lapply(cancer_types, function(X) log10(all_tcga$cellfrac[[X]][, -c(4,10)]*100+0.001))
all_tcga$cellfrac <- tmp_cellfrac; names(all_tcga$cellfrac) <- cancer_types
all_tcga$cellfrac$NSCLC <-  rbind(all_tcga$cellfrac$LUAD, all_tcga$cellfrac$LUSC)
tmp2 <-  all_tcga$cellfrac$NSCLC
tmp2 <- tmp2[,!colnames(tmp2) == "Other"]
tmp2[, "CD4 T"] <- tmp2[, "CD4 T"] + tmp2[, "Treg"]
colnames(tmp2)[colnames(tmp2) == "CD8+ T"] <- "CD8 T"

## TFs
tmp_tf <- lapply(cancer_types, function(X) all_tcga$tf[[X]])
all_tcga$tf <- tmp_tf; names(all_tcga$tf) <- cancer_types
all_tcga$tf$NSCLC <-  rbind(all_tcga$tf$LUAD, all_tcga$tf$LUSC)

input_features <- cbind(all_tcga$pathway$NSCLC, all_tcga$tf$NSCLC, tmp2)
tissue <- "tumor"

# Filter for FDR <= 0.05 & corr > 0)
feat_cor_hif <- feat_cor_hifs[[tissue]][[cancer_type]] %>% 
  group_by(feature, cancertype, hif) %>%
  filter(FDR <= 0.05 && cor > 0 && cancertype == cancer_type)

yes_hif <- unique(feat_cor_hif$feature)
not_hif <- setdiff(colnames(input_features), unique(feat_cor_hif$feature))

# Change patient id -
patients <- substr(rownames(input_features), 1 ,12)
patients <- gsub(".", "-", patients, fixed = TRUE)
features_df <- reshape2::melt(input_features)
features_df$patient <- patients

# Add bagaev info
features_df_mfp <- inner_join(Bagaev_mfp, features_df, by = "patient")

# Add view information
features_df_mfp$view <- "TFs"
features_df_mfp$view[features_df_mfp$variable %in% colnames(all_tcga$pathway$NSCLC)] <- "Pathways"
features_df_mfp$view[features_df_mfp$variable %in% colnames(tmp2)] <- "Cell fractions"
features_df_mfp$variable <- as.character(features_df_mfp$variable)

# Keep only correlated features
features_df_mfp_main <- subset(features_df_mfp, variable %in% yes_hif)
# features_df_mfp_supp <- subset(features_df_mfp, variable %in% not_hif)

# Calculate median feature values across patients
features_df_mfp_main_median <- features_df_mfp_main %>%
  group_by(variable, MFP, view) %>%
  dplyr::summarise(median_value=median(value))

# Sort molecular subtypes
features_df_mfp_main_median$MFP <- factor(features_df_mfp_main_median$MFP,
                                          levels = c("F", "IE/F", "D", "IE"))

## Quantitative evaluation HIF features (F>IE or IE/F>IE) 
### Visualize the data ##
fibrotic <- filter(features_df_mfp_main, MFP %in% c("F"))
#hist(fibrotic$value)
enriched_fibrotic <- filter(features_df_mfp_main, MFP %in% c("IE/F"))
#hist(enriched_fibrotic$value)
enriched <- filter(features_df_mfp_main, MFP %in% c("IE"))
#hist(enriched$value)

# compute wilcoxon sum rank test for each variable
test <- do.call(rbind, lapply(unique(features_df_mfp_main$variable), function(x) {
  # consider only the data for that variable and separate R and NR
  tmp <- subset(features_df_mfp_main, variable == x & MFP %in% c("F", "IE/F", "IE"))
  # compute average
  tmp_mean <- tapply(tmp$value, tmp$MFP, mean)
  # compute wilcoxon sum rank test, effect size and sign
  stattest <- rstatix::wilcox_test(data = tmp, value ~ MFP, ref.group = "IE")
  effsize <- rstatix::wilcox_effsize(data = tmp, value ~ MFP, ref.group = "IE")
  signs <- c(sign(tmp_mean["F"] - tmp_mean["IE"]), sign(tmp_mean["IE/F"] - tmp_mean["IE"]))
  p_val <- stattest$p
  eff_size <- effsize$effsize
  # Summary
  tmp_df <- data.frame(
    datatype = unique(tmp$view),
    variable = x,
    comparison = paste0(stattest$group2,">",stattest$group1),
    p_val = p_val,
    eff_size = eff_size,
    sign = as.numeric(signs)
  )
  return(tmp_df)
}))

test$signedEffect <- test$eff_size * test$sign
test$threshold <- as.numeric(as.factor(test$p_val <= 0.05))
test$threshold <- factor(test$threshold,levels = c(1, 2),labels = c("notSign", "Sign"))

xminmax <- max(abs(test$eff_size))
xminmax <- xminmax + xminmax * 0.01
ymax <- max(-log10(test$p_val))
ymax <- ymax + ymax * 0.01

# Add MOFA weight to df
mofa_nsclc_w_df <- df_tcga_weights_median %>% 
  filter(cancertype == cancer_type) %>%
  dplyr::rename('variable' = 'feature')

test_w_df <- inner_join(mofa_nsclc_w_df, test, by = "variable")

# -------------------------------------------- #
## Heatmap: features across molecular subtypes ##
# -------------------------------------------- #

## all features together ##

### sort features by median eff size, and then by view
tmp2 <- test_w_df %>% group_by(variable, view) %>%
  dplyr::summarise(eff_size_median = median(signedEffect)) %>%
  dplyr::arrange(desc(eff_size_median))

sort_features <- c(subset(tmp2, view == "Immune cells quantification")$variable,
                   subset(tmp2, view == "Pathway scores")$variable,
                   subset(tmp2, view == "Transcription factors")$variable)

# scale featuresa per subtype
features_df_mfp_main_median <- features_df_mfp_main_median %>%
  dplyr::group_by(variable) %>%
  dplyr::mutate(scaled_median_value = scale(median_value))

# Extract name significant features
significant_features <- unique(subset(test_w_df, threshold == "Sign" & sign == 1)$variable)
facet_features <- rep("plain", length(sort_features)); names(facet_features) <- rev(sort_features)
facet_features[significant_features] <- "bold"

features_df_mfp_main_median$variable <- factor(features_df_mfp_main_median$variable,
                                               levels = rev(sort_features))
features_df_mfp_main_median$MFP <- factor(features_df_mfp_main_median$MFP,
                                               levels = c("IE/F", "F", "IE", "D"))

gg_all <- features_df_mfp_main_median %>%
  ggplot(aes(x=MFP, y=variable, fill = scaled_median_value)) +
  geom_tile() +
  ggplot2::scale_fill_distiller(palette="RdBu", direction=-1, name = "Z-score \n",
                                guide = guide_colorbar(label = TRUE,frame.colour = "black")) +
  ggplot2::theme_minimal() +
  ggplot2::theme(axis.text.x = element_text(size=12, angle = 0, hjust=1, vjust= 0.5, color = "black"),
                 axis.text.y = element_text(size=12, angle = 0, color = "black", face = facet_features[rev(sort_features)]),
                 axis.title.x = element_blank(),
                 axis.title.y = element_blank(),
                 axis.ticks.x = element_blank(), axis.ticks.y = element_blank(),
                 legend.position = "top", legend.title.align=0.5, 
                 legend.key = element_rect(color = 'black'),
                 legend.text = element_text(size = 10)) +
    scale_x_discrete(expand=c(0,0)) + 
    scale_y_discrete(expand=c(0,0))

ggsave(filename = "../../../../Figure3A.pdf", width = 6, height = 10)
svglite(filename = "../../../../Figure3A.svg", width = 4, height = 8, fix_text_size = FALSE, scaling = 0.6)
gg_all
dev.off()

cat("Proportion of the features that are higher in fibrotic tumors:", (table(facet_features)[1]/ length(facet_features)) * 100, "%")

# -------------------------------------------- #
## Volcano plots: IE vs IE/F and IE vs F ##
# -------------------------------------------- #

colors_palette <- brewer.pal(9, "RdBu")
colors_sign <- c(colors_palette[9], colors_palette[1]); names(colors_sign) <- c("-1","1")

## F vs IE ##
test_w_df$sign_weight <- factor(sign(test_w_df$weight), levels = c(-1,1))

volcano_plot_FvsIE <- ggplot2::ggplot(
  data = subset(test_w_df, comparison == "F>IE"),
  ggplot2::aes(x = signedEffect, y = -log10(p_val), size = abs(weight), fill = sign_weight, color= sign_weight, shape = sign_weight)) +
  ggplot2::geom_point() +
  ggplot2::xlim(c(-xminmax, xminmax)) +
  ggplot2::ylim(c(0, ymax)) +
  ggplot2::xlab("higher in IE          effect size          higher in F") +
  ggplot2::ylab("-log10 p-value") +
  ggplot2::scale_fill_manual(labels = names(colors_sign), values = colors_sign, name = "Sign of MOFA weight") +
  ggplot2::scale_color_manual(labels = names(colors_sign), values = colors_sign, name = "Sign of MOFA weight") +
  ggplot2::scale_size_continuous(name = "MOFA weight", guide = "none") +
  ggplot2::scale_shape_manual(values = c(25,24), labels= names(colors_sign), name = "Sign of MOFA weight") +
  ggplot2::theme_bw() +
  ggplot2::geom_hline(yintercept = -log10(0.05), linetype = "longdash", colour = "#9e9e9e") +
  ggplot2::geom_vline(xintercept = 0, linetype = "solid", colour = "#9e9e9e") +
  ggplot2::theme(axis.text = ggplot2::element_text(color = "black"),
                 axis.ticks = ggplot2::element_line(color = "black")) +
  ggplot2::theme(legend.position = "top") +
  ggplot2::ggtitle("")

# Add labels
volcano_plot_FvsIE <- volcano_plot_FvsIE + ggrepel::geom_text_repel(
  data = subset(test_w_df, threshold != "notSign" & comparison == "F>IE"),
  ggplot2::aes(x = signedEffect, y = -log10(p_val), label = variable, size = .3),show.legend = NA, inherit.aes = FALSE, max.overlaps = 20)

## IE/F vs IE ##
test_w_df$sign <- factor(test_w_df$sign)
test_w_df$sign_weight <- factor(sign(test_w_df$weight), levels = c(-1,1))

volcano_plot_IEFvsIE <- ggplot2::ggplot(
  data = subset(test_w_df, comparison == "IE/F>IE"),
  ggplot2::aes(x = signedEffect, y = -log10(p_val), size = abs(weight), fill = sign_weight, color= sign_weight, shape=sign_weight)) +
  ggplot2::geom_point() +
  ggplot2::xlim(c(-xminmax, xminmax)) +
  ggplot2::ylim(c(0, ymax)) +
  ggplot2::xlab("higher in IE          effect size          higher in IE/F") +
  ggplot2::ylab("-log10 p-value") +
  ggplot2::scale_fill_manual(labels = names(colors_sign), values = colors_sign, name = "Sign of MOFA weight") +
  ggplot2::scale_color_manual(labels = names(colors_sign), values = colors_sign, name = "Sign of MOFA weight") +
  ggplot2::scale_size_continuous(name = "MOFA weight") +
  ggplot2::scale_shape_manual(values = c(25,24), labels= names(colors_sign), name = "Sign of MOFA weight") +
  ggplot2::theme_bw() +
  ggplot2::geom_hline(yintercept = -log10(0.05), linetype = "longdash", colour = "#9e9e9e") +
  ggplot2::geom_vline(xintercept = 0, linetype = "solid", colour = "#9e9e9e") +
  ggplot2::theme(axis.text = ggplot2::element_text(color = "black"),
                 axis.ticks = ggplot2::element_line(color = "black")) +
  ggplot2::theme(legend.position = "top")

# Add labels
volcano_plot_IEFvsIE <- volcano_plot_IEFvsIE + ggrepel::geom_text_repel(
  data = subset(test_w_df, threshold != "notSign" & comparison == "IE/F>IE"),
  ggplot2::aes(x = signedEffect, y = -log10(p_val), label = variable, size = .3), show.legend = NA, inherit.aes = FALSE, max.overlaps = 20)

# Combine volcano plots in one page
volcano_plots <- ggarrange(volcano_plot_FvsIE, volcano_plot_IEFvsIE, nrow = 1, ncol= 2, common.legend = FALSE, align = "h")

svglite(filename = "../../../../FigureS10.svg", width = 16, height = 8, fix_text_size = FALSE, scaling = 0.6)
volcano_plots
dev.off()


```

## iHet predictive power for ICB immunotherapy in NSCLC

```{r}

datasets_bulk <-c("mariathasan" = "BLCA",
                  "gideauslanderpd1" = "SKCM",
                  "kim" =  "STAD",
                  "jung.nsclc" = "NSCLC")

dataset <- "jung.nsclc"
hif_type <- "NSCLC"

# data
tmp_dataset <- sapply(strsplit(dataset, ".", fixed = TRUE), head , 1)
tmp <- import_dataset(tmp_dataset)
response <- tmp$response

# -------------------------------------------- #
## Compute iHet scores (using scaled weights) ##
# -------------------------------------------- #

# get cancer type
model <- as.character(datasets_bulk[dataset])
  
all_dataset=tmp$all_dataset
nR <- table(response)["R"]
nNR <- table(response)["NR"]

counts <- all_dataset$counts[,names(response)]
tpm    <- all_dataset$tpm[,names(response)]

# To list
all_dataset <- list(counts = counts,
                    tpm = tpm)
# run iHet
iHet_df <- compute_iHet(dataset = all_dataset,
                        model = model, # specify cancer-type-specific MOFA model
                        use_bootstrap_weights=TRUE, # indicate if bootstrap models should be used
                        method = c("iHet", "iHet_inverted"),
                        use_fibroblasts_hifs_tissue = c("tumor"),
                        cancer_type_hifs = hif_type, # specify cancer-type specific hifs (NSCLC or pancancer)
                        assess_cor_threshold = FALSE, # If TRUE, it assess the correlation threshold (0-0.3).
                        scale_mofa_weights = TRUE) # use all correlated features (not refined set)

iHet_df <- compute_iHet(dataset = all_dataset,
                        model = model, # specify cancer-type-specific MOFA model
                        use_bootstrap_weights=TRUE, # indicate if bootstrap models should be used
                        method = c("iHet"),
                        scale_mofa_weights = TRUE)

iHet_df$hif_model <- hif_type
iHet_df$hif_model[iHet_df$method == "iHet"] <- "original"
iHet_df$dataset <- dataset

#saveRDS(iHet_df, paste0("./iHet_ms/", dataset,"_iHet_scores_with_hifs_model_", tolower(hif_type),"_using_scaled_weights.RDS"))

# -------------------------------------------- #
## Plot ROC and PR curves ##
# -------------------------------------------- #

# Load iHet scores
iHet_df <- readRDS(paste0(folderValidationiHet, dataset,"_iHet_scores_with_hifs_model_", tolower(hif_type),"_using_scaled_weights.RDS"))

# Unknown histology, average LUAD and LUSC iHet scores is used
## normalize to -1,1
iHet_df_norm <- iHet_df %>% 
  group_by(method, run, model) %>% 
  dplyr::mutate(scaled_score = linear_func(score, "11")) %>%
  group_by(patient, method, run, hif_tissue, dataset) %>% 
  dplyr::summarise(score = mean(scaled_score))

# if (dataset %in% "jung.nsclc") iHet_df_old <- aggregate(iHet_df, score ~ patient + method + run + hif_tissue + dataset, FUN = "mean")

# Filter for patients with available response
iHet_df <- iHet_df %>% filter(patient %in% names(response))

PRcurve <- assess_predictive_performance(iHet=iHet_df_old,
                                         response = response,
                                         use_bootstrap_weights=TRUE,
                                         method = c("iHet", "iHet_inverted"),
                                         use_fibroblasts_hifs_tissue = c("tumor"),
                                         assess_cor_threshold = FALSE,
                                         plot_roc=TRUE,
                                         metric="precision_recall")

ROCcurve <- assess_predictive_performance(iHet=iHet_df_norm,
                                          response = response,
                                          use_bootstrap_weights=TRUE, 
                                          method = c("iHet", "iHet_inverted"),
                                          use_fibroblasts_hifs_tissue = c("tumor"),
                                          assess_cor_threshold = FALSE, 
                                          plot_roc=TRUE,
                                          metric="roc")

pdf(file = paste0("../../../../iHet_iHetRev_PRcurve_", dataset, ".pdf"), width = 8, height = 8)

# svglite(filename = paste0("./iHet_ms/iHet_iHetRev_PRcurve_", dataset, ".svg"),
#         width = 12, height = 12, fix_text_size = FALSE, scaling = 0.6)

PRcurve
dev.off()

pdf(file = paste0("./../../../iHet_iHetRev_ROCcurve_", dataset, ".pdf"), width = 8, height = 8)

# svglite(filename = paste0("./iHet_ms/iHet_iHetRev_ROCcurve_", dataset, ".svg"),
#         width = 12, height = 12, fix_text_size = FALSE, scaling = 0.6)

ROCcurve
dev.off()

```

## iHet is conserved across cancer types

```{r}

# ------------------------------------------------------------------------------- #
## Correlation between iHet signature in different cancer types ##
# ------------------------------------------------------------------------------- #

# MOFA bootstrap weights
df_tcga_weights <- readRDS(file = "../data/all_tcga_iHet_weights_bootstrap_noDCandMono_scaled.RDS")
df_tcga_weights_median <- aggregate(df_tcga_weights, weight ~ feature + factor + view + cancertype, FUN = "median")
weight_mat <- df_tcga_weights_median %>% pivot_wider(id_cols = feature, names_from = cancertype, values_from = weight)
weight_mat <- weight_mat %>% tibble::column_to_rownames("feature")

cancer_types <- unique(df_tcga_weights_median$cancertype)
cor_res <- rstatix::cor_mat(weight_mat, method = "pearson")

cor_mat <- cor_res %>%
  tibble::column_to_rownames("rowname") %>%
  as.matrix()

cor_pmat <- rstatix::cor_get_pval(cor_res) %>%
  tibble::column_to_rownames("rowname") %>%
  as.matrix()

rdbu10_palette <- c(
  "#67001F", "#B2182B", "#D6604D", "#F4A582",
  "#FDDBC7", "#FFFFFF", "#D1E5F0", "#92C5DE",
  "#4393C3", "#2166AC", "#053061"
)

tmp <- cor_mat[-which(colnames(cor_mat) %in% c("LUAD", "LUSC", "NSCLC")), "NSCLC"]

cat("Median Pearson correlation:", median(tmp[!names(tmp) %in% c("LIHC", "PRAD")]))

cat("LIHC median Pearson correlation:", tmp["LIHC"])
cat("PRAD median Pearson correlation:", tmp["PRAD"])

# Barplots with correlations (with iHet NSCLC)
tmp <- cor_mat[-which(colnames(cor_mat) %in% c("LUAD", "LUSC", "NSCLC")), "NSCLC"]
cor_df <- data.frame(PeCorr=tmp,
                     CancerType = names(tmp))

# ------------------------------------------------------------------------------- #
## Correlation between iHet signature and immune response different cancer types ##
# ------------------------------------------------------------------------------- #

# retrieve iHet score TCGA patients
tcga_iHet_scores <- readRDS(file = paste0(repo_dir, "/data/tcga_ihet_scores/all_tcga_iHet_scores.RDS"))
colnames(tcga_iHet_scores)[1] <- "pat_id"
tcga_iHet_scores$pat_id <- gsub(".", "-", tcga_iHet_scores$pat_id, fixed = TRUE)
tcga_iHet_scores$pat_id <- substr(tcga_iHet_scores$pat_id, 1, 12)
tcga_iHet_scores <- aggregate(tcga_iHet_scores, score ~ method + model + pat_id, FUN = "median")

# Immune response score
all_tcga <- readRDS("../../../iHet_data/features/TCGA_expr_data.features.rds")
#all_tcga[["immresp"]][["GBM"]] <- NULL
all_tcga[["immresp"]][["NSCLC"]] <- rbind(all_tcga[["immresp"]][["LUAD"]], all_tcga[["immresp"]][["LUSC"]])
IR <- all_tcga[["immresp"]]

# Ensemble IR
selscores <- colnames(IR$BLCA)[1:9]
pancancer_IR <- lapply(names(IR), function(cancertype){
   IR[[cancertype]]$response <- NULL
   immscoreZ <- immscoreZ[match(selscores, immscoreZ$score), ]
   response <- IR[[cancertype]][, match(selscores, colnames(IR[[cancertype]]))]
   response <- ((t(response) - immscoreZ$mean) / immscoreZ$sd)
   response <- apply(response, 2, median)
  return(as.matrix(t(response)))
})
names(pancancer_IR) <- names(IR)

# to data.frame
IR_df <- reshape2::melt(pancancer_IR)
colnames(IR_df) <- c("method", "pat_id", "score", "model")
IR_df$pat_id <- substr(gsub(".", "-", IR_df$pat_id, fixed = TRUE), 1, 12)
IR_df$method <- "IR"
IR_df <- IR_df[, colnames(tcga_iHet_scores_median)]

# Join iHet and IR
tcga_all <- union(tcga_iHet_scores_median, IR_df)

# Pivot wider
tcga_df <- tcga_all %>% 
  filter(!method %in% c("iHet_inverted", "iHet_removed")) %>% 
  tidyr::pivot_wider(names_from=method, values_from=score)

scatterplot_IR_vs_iHet <- ggplot(tcga_df, aes(x = iHet, y = IR)) + 
  geom_point(size = 0.8, color = "#333333") +
  geom_smooth(method = "lm") +
  facet_wrap(model ~ ., scales = "free") + 
  theme_bw(base_size = 15) +
  stat_cor(method="pearson")

svglite(filename = "../../../../FigureS11.svg", width = 8, height = 8, fix_text_size = FALSE, scaling = 0.6)
scatterplot_IR_vs_iHet
dev.off()

## Conservation ##

# iHet #
tmp <- tcga_iHet_scores %>% filter(!model %in% c("LUAD", "LUSC", "NSCLC")) %>% group_by(model) %>% dplyr::summarise(n=n()/3)
tmp <- tmp %>% dplyr::rename("CancerType" = "model")
cor_df_mofa <- inner_join(cor_df, tmp)
cor_df_mofa$CancerType_n <- paste0(cor_df_mofa$CancerType, " (n=", cor_df_mofa$n,")")
cor_df_mofa$analysis <- "MOFA"

# IR #
tmp <- tcga_iHet_scores %>% filter(!model %in% c("LUAD", "LUSC", "NSCLC")) %>% group_by(model) %>% dplyr::summarise(n=n()/3)
tmp <- tmp %>% dplyr::rename("CancerType" = "model")

cor_df_IR <- data.frame(PeCorr=as.numeric(tcga_mat_cor[1,]),
                     CancerType = colnames(tcga_mat_cor))

cor_df_IR <- inner_join(cor_df_IR, tmp)
cor_df_IR$CancerType_n <- paste0(cor_df_IR$CancerType, " (n=", cor_df_IR$n,")")
cor_df_IR$analysis <- "IR"

# Join plot
cor_df <- rbind(cor_df_IR, cor_df_mofa)

barplot_double_PeCorr <- ggplot2::ggplot(cor_df, aes(x=CancerType_n, y=PeCorr, fill = analysis)) +
  geom_bar(stat = "identity", color = "black", position = position_dodge2()) +  # fill = "#B2182B"
  coord_flip() +
  theme_classic() +
  ylim(c(0,1)) +
  theme(axis.title.y = element_blank(), strip.background = element_blank(), 
        axis.title.x = element_text(size = 14, face = "plain", color = "black"),
        axis.text.x = element_text(size = 14, face = "plain", angle = 45, color = "black", hjust = 0.5, vjust = 0.5),
        axis.text.y = element_text(size = 14, face = "plain", hjust = 1, angle = 0, color = "black"),
        legend.position = "top", 
        legend.text = element_text(size = 14), 
        legend.title = element_text(size = 14)) +
  labs(y = "Pearson correlation")

svglite(filename = "../../../../Figure3D.pdf", width = 8, height = 4, fix_text_size = FALSE, scaling = 0.6)
barplot_double_PeCorr
dev.off()

# ------------------------------------------------------------------------------- #
## Cancer-specific iHet feature weights ##
# ------------------------------------------------------------------------------- #

# Calculate median across bootstrap samples
median_weights <- stats::aggregate(weight ~ factor + feature + cancertype + view, 
                                   data = df_tcga_weights, FUN="median")

# Sort features by mean across cancer types
mean_features <- aggregate(weight ~ factor + feature, data = median_weights, FUN = "mean")
mean_features <- mean_features[order(abs(mean_features$weight), decreasing = TRUE),]
median_weights$feature <- factor(median_weights$feature, levels = as.character(mean_features$feature))

pancancer_F1_weights <- ggplot2::ggplot(median_weights, aes(x = cancertype, y = feature, color = weight, size = abs(weight))) +
  ggplot2::geom_point()+ 
  ggplot2::scale_color_distiller(palette="RdBu", direction=-1, name = "iHet weights \n") +
  ggplot2::scale_size_continuous(name = " ") +
  ggplot2::theme_minimal() +
  ggplot2::theme(axis.text.x = element_text(size=12, angle = 45, vjust = 0.1, hjust = 0, color = "black"), 
                 axis.title.x = element_blank(),
                 axis.text.y = element_text(size=12, angle = 0, hjust = 0.9, color = "black"),
                 axis.title.y = element_blank(), axis.ticks.x = element_blank(), axis.ticks.y = element_blank(),
                 legend.position = "top", legend.direction = "horizontal", strip.text.y = element_text(size = 12, color = "black"),
                 legend.text=element_text(size=12, angle = 0, hjust = 0.8),  
                 legend.title = element_text(size =14, face = "bold", vjust = .9))

svglite(filename = "../../../../FigureS12", width = 8, height = 14, fix_text_size = FALSE, scaling = 0.6)
pancancer_F1_weights
dev.off()

```

## iHet and iHet_rev relation with immune infiltration and exclusion

```{r}

# -------------------------------------------- #
# iHet and iHet_rev classification of patients and association with microenvironment subtypes
# -------------------------------------------- #

# Add bagaev immune subtype (validation) #
Bagaev_mfp <- readxl::read_xlsx(params$dataBagaevMFP, sheet = 1)
colnames(Bagaev_mfp) <- Bagaev_mfp[1,]
Bagaev_mfp <- Bagaev_mfp[-1,]
Bagaev_mfp <- Bagaev_mfp %>% 
  filter(Cohort %in% c("Gide", "Auslander", "Liu", "Hugo", "Riaz") & Therapy == "aPD1") %>% 
  select(Sample, MFP)
Bagaev_mfp <- Bagaev_mfp %>% as.data.frame() %>% dplyr::rename('patient' = 'Sample')

dataset <- "gideauslanderpd1"
dataset <- "mariathasan"

hif_type <- "NSCLC"

# Load iHet scores
iHet_df <- readRDS(paste0(folderValidationiHet, dataset,"_iHet_scores_with_hifs_model_", tolower(hif_type),"_using_scaled_weights.RDS"))

# Add response
tmp_dataset <- sapply(strsplit(dataset, ".", fixed = TRUE), head , 1)
tmp <- import_dataset(tmp_dataset)
response <- tmp$all_dataset$clinical_response
response$patient <- rownames(response)

# mariathasan
response <- response[, c("patient", "Best Confirmed Overall Response", "Immune phenotype")]
colnames(response) <- c("patient", "BCOR", "MFP")
iHet_df <- inner_join(iHet_df, response, by = "patient")
iHet_df$response <- gsub("CR|PR","R", iHet_df$BCOR)
iHet_df$response <- gsub("SD|PD","NR", iHet_df$response)

# gideauslander
response <- tmp$response
response_df <- data.frame(patient = names(response), response = response)
iHet_df <- right_join(Bagaev_mfp, iHet_df, by = "patient")
iHet_df <- inner_join(iHet_df, response_df, by = "patient")

# calculate median score across runs
iHet_df_median <- iHet_df %>% 
  group_by(patient, dataset, method, response, MFP) %>% 
  dplyr::summarise(median_score = median(score))

# normalize to -1,1
iHet_df_median <- iHet_df_median %>% 
  filter(method != "iHet_exclusion" & is.na(MFP) == FALSE) %>%
  group_by(method, dataset) %>% 
  dplyr::mutate(scaled_median_score = linear_func(median_score, "11"))

iHet_df_rank_median <- iHet_df_median %>%
  group_by(method, dataset) %>% 
  dplyr::mutate(rank = rank(median_score), inv_rank = rank(-median_score))

iHet_df_rank_median$category <- as.numeric(cut_number(iHet_df_rank_median$inv_rank, 3))
iHet_df_rank_median$category <- gsub(1, "Tertile 1", iHet_df_rank_median$category)
iHet_df_rank_median$category <- gsub(2, "Tertile 2", iHet_df_rank_median$category)
iHet_df_rank_median$category <- gsub(3, "Tertile 3", iHet_df_rank_median$category)
iHet_df_rank_median$category <- factor(iHet_df_rank_median$category, 
                                        levels = c("Tertile 3", "Tertile 2", "Tertile 1"))

iHet_df_rank_median$category <- gsub("Tertile 1", "High resp", iHet_df_rank_median$category)
iHet_df_rank_median$category <- gsub("Tertile 2", "Mid resp", iHet_df_rank_median$category)
iHet_df_rank_median$category <- gsub("Tertile 3", "Low resp", iHet_df_rank_median$category)
iHet_df_rank_median$category <- factor(iHet_df_rank_median$category, levels = c("Low resp", "Mid resp", "High resp"))
iHet_df_rank_median$method <- gsub("iHet_inverted", "iHet_rev", iHet_df_rank_median$method)

frac_pat_response <- iHet_df_rank_median %>%
  #dplyr::mutate(category = ifelse(category %in% c("Tertile 1", "Tertile 2"), "T1-T2", "T3")) %>%
  dplyr::group_by(dataset, method, response, category, MFP) %>%
  dplyr::summarise(counts = n()) %>%
  dplyr::group_by(category, method, dataset) %>%
  dplyr::mutate(frac = counts/sum(counts))

conflicts_prefer(ggplot2::theme_minimal)

gg <- frac_pat_response %>% filter(is.na(MFP) == FALSE) %>%
  ggplot2::ggplot(aes(x = category, y = counts, fill = MFP, label = counts)) +
  ggplot2::geom_bar(position = "stack", stat="identity") +
  scale_fill_manual(values = c("#64a860", "#9970c1","#b98d3e","#cc545e")) +
  geom_text(size = 3, position = position_stack(vjust = 0.5), color = "white") +
  ggplot2::facet_grid(response ~ method, labeller = as_labeller(c(NR="Non-responders", R="Responders", iHet = "iHet", iHet_rev="iHet_rev"))) +
  theme_minimal() +
  theme(axis.title.x = element_blank(), strip.background = element_blank(), 
        strip.text = element_text(size = 14, face ="plain"),
        axis.title.y = element_text(size = 14, face = "plain", color = "black"),
        axis.text.x = element_text(size = 14, face = "plain", angle = 0, color = "black"),
        axis.text.y = element_text(size = 14, face = "plain", hjust = 1, angle = 0, color = "black"),
        legend.position = "top", legend.text = element_text(size = 14), legend.title = element_text(size = 14)) +
  labs(y = "Number of patients", fill = "Microenvironment subtype")  

svglite(filename = "../../../../FigureS13.svg", width = 10, height = 10, fix_text_size = FALSE, scaling = 0.6)
gg
dev.off()

```

## iHet and iHet_rev predictive value in BLCA, SKCM, NSCLC and STAD

```{r}

datasets_bulk <-c("mariathasan" = "BLCA",
                  "gideauslanderpd1" = "SKCM",
                  "kim" =  "STAD",
                  "jung.nsclc" = "NSCLC")

# NSCLC
hif_type <- "NSCLC"

# -------------------------------------------- #
# Compute iHet scores # 
# -------------------------------------------- #

lapply(names(datasets_bulk), function(dataset){

  # data
  tmp_dataset <- sapply(strsplit(dataset, ".", fixed = TRUE), head , 1)
  tmp <- import_dataset(tmp_dataset)
  response <- tmp$response

  # get cancer type
  model <- as.character(datasets_bulk[dataset])
  
  all_dataset=tmp$all_dataset
  nR <- table(response)["R"]
  nNR <- table(response)["NR"]

  counts <- all_dataset$counts[,names(response)]
  tpm    <- all_dataset$tpm[,names(response)]
  
  if (dataset == "mariathasan"){
    counts <- solve_annotation_issues(gene_expr = counts)
    tpm <- solve_annotation_issues(gene_expr = tpm)
  }

  # To list
  all_dataset <- list(counts = counts,
                      tpm = tpm)
  # run iHet
  iHet_df <- compute_iHet(dataset = all_dataset,
                          model = model, # specify cancer-type-specific MOFA model
                          use_bootstrap_weights=TRUE, # indicate if bootstrap models should be used
                          method = c("iHet", "iHet_inverted", "iHet_exclusion"),
                          use_fibroblasts_hifs_tissue = c("tumor"),
                          cancer_type_hifs = hif_type, # specify cancer-type specific hifs (NSCLC or pancancer)
                          assess_cor_threshold = FALSE, # If TRUE, it assess the correlation threshold (0-0.3).
                          scaled = TRUE) # use all correlated features (not refined set)

  iHet_df$hif_model <- hif_type
  iHet_df$hif_model[iHet_df$method == "iHet"] <- "original"
  iHet_df$dataset <- dataset

  saveRDS(iHet_df, paste0("./iHet_ms/", dataset,"_iHet_scores_with_hifs_model_", tolower(hif_type),"_using_scaled_weights.RDS"))

})

# Re-format iHet data.frame

lapply(names(datasets_bulk), function(dataset){

  tmp <- readRDS(paste0("./iHet_ms/", dataset,"_iHet_scores_with_hifs_model_", tolower(hif_type),"_using_scaled_weights.RDS"))
  colnames(tmp) <- c("patient", "score", "hif_tissue", "method","run", "hif_model", "dataset")
  saveRDS(tmp, paste0("./iHet_ms/", dataset,"_iHet_scores_with_hifs_model_", tolower(hif_type),"_using_scaled_weights.RDS"))

  return(tmp)
})

# -------------------------------------------- #
## Compute performance 1. AUC, 2.PR ##
# -------------------------------------------- #

auc_df <- do.call(rbind, lapply(names(datasets_bulk), function(dataset){
  cat("Dataset:", dataset, "\n")
      cat("Cancer type hifs:", hif_type, "\n")

      # data
      tmp_dataset <- sapply(strsplit(dataset, ".", fixed = TRUE), head , 1)
      tmp <- import_dataset(tmp_dataset)
      response <- tmp$response

      if (dataset %in% c("mariathasan", "gideauslanderpd1", "kim", "jung.nsclc")){
        # iHet scores
        iHet_df <- readRDS(paste0("./iHet_ms/", dataset,"_iHet_scores_with_hifs_model_", tolower(hif_type),"_using_scaled_weights.RDS"))
        
        # Unknown histology, average LUAD and LUSC iHet scores is used
        if (dataset %in% "jung.nsclc") iHet_df <- aggregate(iHet_df, score ~ patient + method + run + hif_tissue + dataset, FUN = "mean")

      }
      
      # Remove model variable
      iHet_df$model <- NULL
      
      # Filter for patients with available response
      iHet_df <- iHet_df %>% filter(patient %in% names(response))
      
      auc_df <- assess_predictive_performance(iHet=iHet_df,
                                              response = response,
                                              use_bootstrap_weights=TRUE, 
                                              method = c("iHet", "iHet_inverted"),
                                              use_fibroblasts_hifs_tissue = c("tumor"),
                                              assess_cor_threshold = FALSE, 
                                              plot_roc=FALSE,
                                              metric="precision_recall") #roc
      
      nR <- table(response)["R"]
      nNR <- table(response)["NR"]
      auc_df$dataset <- paste0(dataset, "\n(R=", nR, "; NR=", nNR, ")")
      
      return(auc_df)
}))

# -------------------------------------------- #
## Boxplots, AUC and AUCPR distributions
# -------------------------------------------- #

# iHet vs iHet_inverted (iHet_rev)
auc_df$method <- factor(auc_df$method, levels = c("iHet", "iHet_inverted"))
      
# Sort datasets
levels_datasets <- c("gideauslanderpd1\n(R=20; NR=30)", "mariathasan\n(R=25; NR=167)", 
                     "kim\n(R=12; NR=33)", "jung.nsclc\n(R=8; NR=19)")
auc_df$dataset <- factor(auc_df$dataset, levels = unique(levels_datasets))
new_labels <- c(expression(SKCM^1), expression(BLCA^4), expression(STAD^3), expression(NSCLC^2))

performance <- ggplot(auc_df, aes(x=dataset, y=auc, fill = method)) +
  geom_boxplot() + #geom_sina(alpha=0.5) +
  scale_y_continuous(limits=c(0, 1)) +
  theme_bw() +
  scale_x_discrete(labels= new_labels) +
  scale_fill_manual(values = c("#aad52e","#d3002e")) +
  theme(
    axis.title.x = element_blank(), 
    axis.title.y = element_text(size = 14, color = "black"),
    axis.text.y = element_text(size = 14, color = "black"),
    axis.text.x = element_text(size = 14, color = "black", angle = 45, hjust = 0.5, vjust = 0.5),
    legend.direction = "horizontal", legend.position = "top", legend.text = element_text(size = 14),
    legend.title = element_text(size = 14)
  ) +
  #labs(y = "Area Under the ROC Curve (AUROC)", fill = "Method")
  labs(y = "Area Under Precision-Recall Curve (AUPRC)", fill = "Method")

svglite(filename = "../../../../Figure3E.svg", width = 8, height = 8, fix_text_size = FALSE, scaling = 0.6)
# svglite(filename = "../../../../Figure3F.svg", width = 8, height = 8, fix_text_size = FALSE, scaling = 0.6)
performance
dev.off()

```

## Integration with TMB

> Combining three aspects (presence and localization of immune response, and tumor antigenicity)

```{r}

# ------------------------------------------------------------------------------- #
## Correlation between iHet signature and TMB for each TCGA cancer type ##
# ------------------------------------------------------------------------------- #

# Add Bagaev MFP
tcga_all_with_mfp <- inner_join(tcga_all, Bagaev_mfp, by = "pat_id")
tcga_all_with_mfp <- tcga_all_with_mfp %>% filter(method != "iHet_removed")
tcga_all_with_mfp$method <- factor(tcga_all_with_mfp$method, levels = c("IR", "iHet", "iHet_inverted"))
tcga_all_with_mfp$MFP <- factor(tcga_all_with_mfp$MFP, levels = c("D", "F", "IE/F", "IE"))

tmp <- tcga_all_with_mfp %>%
  pivot_wider(names_from=method, values_from=score)
tmp2 <- subset(tmp, !is.na(TMB))
tmp2$TMB <- as.numeric(tmp2$TMB)
              
iHet_vs_TMB <- tmp2 %>%
  ggplot(aes(x = iHet, y = TMB)) +
  geom_point(size=1) +
  scale_color_manual(values = c("#64a860", "#9970c1","#b98d3e","#cc545e")) +
  facet_wrap(model ~ ., scales = "free") +
  theme_bw() +
  theme(panel.grid = element_line(color = "grey", size = 0.25), panel.background = element_blank(),
        legend.position = "top", legend.direction = "horizontal",
        axis.text = element_text(color="black")) +
  stat_cor(method="pearson")

svglite(filename = "./manuscript/iHet_final/scatterplot_iHet_vs_TMB_pancancer.svg", width = 10, height = 10, 
        fix_text_size = FALSE, scaling = 0.6)

iHet_vs_TMB

dev.off()

# With available TMB
datasets_bulk <-c("mariathasan" = "BLCA",
                  "kim" =  "STAD",
                  "jung.nsclc" = "NSCLC")

# normalization unit scale first
normalize = "01_first"
hif_type = "NSCLC"

plots <- lapply(names(datasets_bulk), function(dataset){
  plots <- lapply(c("tumor"), function(tissue){
    
    # path to repo
    repo_dir <- "/Users/Oscar/Desktop/PhD_TU:e/Projects/iHet/repo_predictions/iHet_predictions"
    cat("Dataset: ", dataset, "\n")
    
    # data
    tmp_dataset <- sapply(strsplit(dataset, ".", fixed = TRUE), head , 1)
    tmp <- import_dataset(tmp_dataset)
    response <- tmp$response
    
    # iHet scores
    iHet_df <- readRDS(paste0("./iHet_ms/", dataset,"_iHet_scores_with_hifs_model_", tolower(hif_type),"_using_scaled_weights.RDS"))
    
    if (dataset %in% c("jung.nsclc")){
      # Unknown histology, average LUAD and LUSC iHet scores is used
      iHet_df <- aggregate(iHet_df,
                           score ~ patient + method + run + hif_tissue + dataset,
                           FUN = "mean")
    }
 

    # Immune Exclusion
    ## all runs
    iHet_exclusion_df <- iHet_df %>% filter(method == "iHet_exclusion" &  
                                              hif_tissue == tissue) %>%
      group_by(patient, dataset, method, hif_tissue) %>%
      dplyr::mutate(score = -score)
    
    ## median
    iHet_exclusion_df_median <- iHet_df %>% filter(method == "iHet_exclusion" &  
                                                     hif_tissue == tissue) %>%
      group_by(patient, dataset, method, hif_tissue) %>%
      dplyr::summarize(median_score = median(score))
    
    # iHet
    ## all runs
    iHet_original_df <- iHet_df %>% filter(method == "iHet") %>%
      group_by(patient, dataset, method, hif_tissue)
    
    ## median
    iHet_original_df_median <- iHet_df %>% filter(method == "iHet") %>%
      group_by(patient, dataset, method, hif_tissue) %>%
      dplyr::summarize(median_score = median(score))
    
    # data.frame
    ## all
    myscores_df <- rbind(iHet_original_df, iHet_exclusion_df)
    myscores_df$threshold <- myscores_df$hif_tissue <- myscores_df$dataset <- myscores_df$hif_model <- NULL
    myscores_df <- myscores_df %>% pivot_wider(names_from = "method", values_from = "score")

    ## median
    myscores_df_median <- data.frame(
      patient = as.character(iHet_exclusion_df_median$patient),
      iHet = iHet_original_df_median$median_score,
      iHet_exclusion = - iHet_exclusion_df_median$median_score
    )
    
    # response to treatment
    response <- data.frame(response=tmp$response, patient = names(tmp$response))
    
    ## all
    myscores_df <- inner_join(myscores_df, response, by = "patient")
    if(anyNA(myscores_df$response)) myscores_df <- myscores_df[!is.na(myscores_df$response),]
    ## median
    myscores_df_median$response <- response[myscores_df_median$patient, "response"]
    if(anyNA(myscores_df_median$response)) {
      myscores_df_median <- myscores_df_median[!is.na(myscores_df_median$response),]
    }
    
    # TMB
    TMB <- data.frame(TMB=tmp$TMB, patient = names(tmp$TMB))
    
    ## all
    myscores_df <- inner_join(myscores_df, TMB, by = "patient")
    if (tmp_dataset %in% c("poplar", "oak")) myscores_df$TMB[myscores_df$TMB == ""] <- NA
    if(anyNA(myscores_df$TMB) & !all(is.na(myscores_df$TMB))) {
      myscores_df <- myscores_df[!is.na(myscores_df$TMB),]
    }

    ## median
    myscores_df_median$TMB <- TMB[myscores_df_median$patient, "TMB"]
    if (tmp_dataset %in% c("poplar", "oak")) myscores_df_median$TMB[myscores_df_median$TMB == ""] <- NA
    if(anyNA(myscores_df_median$TMB) & !all(is.na(myscores_df_median$TMB))) {
      myscores_df_median <- myscores_df_median[!is.na(myscores_df_median$TMB),]
    } 
    
    n_NR <- table(myscores_df_median$response)["NR"]
    n_R  <- table(myscores_df_median$response)["R"]
    
    myscores_df_median$dataset <- paste0(dataset, " (NR=", n_NR, ", R=", n_R, ")")
    myscores_df$dataset <- paste0(dataset, " (NR=", n_NR, ", R=", n_R, ")")
    
    # Combine scores (-iHet_exclusion, iHet, TMB)
    
    if (!all(is.na(myscores_df$TMB))){
      
      ### bootstrap
      final.scores_all <- integrated_score(myscores_df, with_TMB = TRUE, 
                                           save_figure_format = c(".pdf"), 
                                           tissue = tissue, normalize = normalize)
      
      ### median
      final.scores_median <- integrated_score(myscores_df_median, with_TMB = TRUE, 
                                              save_figure_format = c(".pdf"), 
                                              tissue = tissue, normalize = normalize)
      
    }
    return(list(median=final.scores_median, bootstrap=final.scores_all))
  })
  names(plots) <-c("tumor")
  return(plots)
})
names(plots) <- names(datasets_bulk)

# -------------------------------------------- #
## Triangle plots, AUC for the weighted average (-iHet_exclusion, iHet, TMB) ##
# -------------------------------------------- #

D <- plots$mariathasan$tumor$bootstrap
E <- plots$kim$tumor$bootstrap
G <- plots$jung.nsclc$tumor$bootstrap

layout_matrix <- matrix(c(1,2,3), nrow = 1, ncol=3, byrow = TRUE)
ggtern::grid.arrange(D,E,G, layout_matrix = layout_matrix)

svglite(filename = "../../.././Figure4BC.svg", width = 14, height = 4, fix_text_size = FALSE, scaling = 0.6)
ggtern::grid.arrange(D,E,G, layout_matrix = layout_matrix)
dev.off()

```

## Example: iHet scores computation for a given dateset

```{r}

# RNA-seq data (counts, TPM (CPM) matrix)
all_dataset <- list(counts = counts, tpm = tpm)
  
# Compute iHet
iHet_df <- compute_iHet(
  dataset = all_dataset, 
  model = "NSCLC", 
  use_bootstrap_weights=TRUE, 
  method = "iHet", 
  scale_mofa_weights = TRUE
)

```

