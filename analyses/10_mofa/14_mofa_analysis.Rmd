---
title: MOFA analysis results
params:
    cpus: 1
    meta: NULL
    input_dir: "../../results/10_mofa/13_run_mofa"
    features_dir: "../../results/10_mofa/12_prepare_mofa_data/datasets"
    easier_dir: "../../results/10_mofa/11_easier"
    tmb_dir: "../../data/01_processed/bulk_rna_seq"
    artifact_dir: "/local/scratch/sturm/mofa"
---

## Load input data
```{r setup, include=FALSE, message=FALSE}
options(bitmapType = "cairo")
message(capture.output(str(params)))
dir.create(file.path(params$artifact_dir, "plots"), showWarnings = FALSE)
knitr::opts_chunk$set(echo = TRUE, dpi = 300, dev = "png", fig.path = "figures/")
source("helper_functions.R")
DATASETS <- c("Jia", "Sharma", "JiaSharma", "LUAD", "LUSC", "NSCLC", "GTEx")
PATHWAYS_OF_INTEREST <- c("JAK-STAT", "VEGF", "PI3K", "NFkB", "Trail", "TNFa")
TFS_OF_INTEREST <- c("SPI1", "NFKB1", "STAT1", "MYC", "E2F4", "E2F2", "ZNF263")
feature_data <- readRDS(file.path(params$features_dir, "data_all_tidy.rds"))

tmb_all <- lapply(c("TCGA_TMB.rds", "Sharma_TMB.rds", "Jia_TMB.rds"), function(tmb_file) {
  tmp_tmb <- readRDS(file.path(params$tmb_dir, tmb_file))
  tmb_df <- tibble(sample = names(tmp_tmb), TMB = tmp_tmb) %>%
    mutate(sample = str_replace_all(sample, "-", "."))
  if (tmb_file == "Sharma_TMB.rds") {
    tmb_df <- tmb_df %>% mutate(sample = paste0("Sharma-", sample))
  }
  if (tmb_file == "Jia_TMB.rds") {
    tmb_df <- tmb_df %>% mutate(sample = paste0("Jia-", sample))
  }
  tmb_df
}) %>%
  bind_rows() %>%
  mutate(`log10(TMB + 1)` = log10(TMB + 1))
```

```{r, include=FALSE}
models <- sapply(DATASETS, function(dataset_id) {
  load_model(file.path(params$input_dir, sprintf("mofa_%s.hdf5", dataset_id)))
}, simplify = FALSE, USE.NAMES = TRUE)

bootstrap_models <- sapply(DATASETS, function(dataset_id) {
  lapply(Sys.glob(file.path(params$input_dir, sprintf("mofa_boot_%s_*.hdf5", dataset_id))), function(x) {
    load_model(x)
  })
}, simplify = FALSE, USE.NAMES = TRUE)
```

```{r, include=FALSE}
median_weights <- sapply(names(bootstrap_models), function(dataset_id) {
  lapply(bootstrap_models[[dataset_id]], get_weight_df) %>%
    bind_rows() %>%
    group_by(view, feature) %>%
    summarise_all(median) %>%
    ungroup()
}, USE.NAMES = TRUE, simplify = FALSE)

saveRDS(median_weights, file = file.path(params$artifact_dir, "median_weights.rds"))
```

## Variance Plots
```{r, results='hide', echo=FALSE}
variance_explained_bootstrap <- lapply(names(bootstrap_models), function(dataset_id) {
  lapply(bootstrap_models[[dataset_id]], function(model) {
    get_variance_explained(model, as.data.frame = TRUE)$r2_per_factor %>%
      mutate(dataset = dataset_id)
  }) %>% bind_rows()
}) %>% bind_rows()
```

```{r, fig.height=4, fig.width=10}
p <- variance_explained_bootstrap %>%
  filter(factor %in% c("Factor1", "Factor2", "Factor3")) %>%
  ggplot(aes(x = factor, y = value, color = view)) +
  facet_wrap(~dataset, nrow = 1) +
  theme_cowplot() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1), legend.position = "top") +
  scale_color_brewer(palette = "Dark2")

add_summary(p, error.plot = "crossbar", fun = "mean") +
  geom_boxplot(alpha = 0, lwd = .7) +
  background_grid() +
  ylab("% variance explained")
```






## Heatmap of bootstrapped factors

```{r, fig.width=15, fig.height=20, echo=FALSE, message=FALSE, warning=FALSE}
svg(file.path(params$artifact_dir, "plots", "heatmap_bootstrapped.svg"), width = 15, height = 20)

all <- buildHeatmap(median_weights$Jia, "Jia") +
  buildHeatmap(median_weights$Sharma, "Sharma") +
  buildHeatmap(median_weights$JiaSharma, "JS") +
  buildHeatmap(median_weights$LUAD, "LUAD") +
  buildHeatmap(median_weights$LUSC, "LUSC") +
  buildHeatmap(median_weights$NSCLC, "NSCLC") +
  buildHeatmap(median_weights$GTEx, "GTEx")

draw(all)

dev.off()
draw(all)
```


```{r, fig.width=15, fig.height=8, echo=FALSE, message=FALSE, warning=FALSE}
get_filtered_weight <- function(model) {
  model %>%
    filter((feature %in% PATHWAYS_OF_INTEREST) | (feature %in% TFS_OF_INTEREST) | (view == "Immune cells quantification"))
}

all <- buildHeatmap(get_filtered_weight(median_weights$Jia), "Jia") +
  buildHeatmap(get_filtered_weight(median_weights$Sharma), "Sharma") +
  buildHeatmap(get_filtered_weight(median_weights$JiaSharma), "JS") +
  buildHeatmap(get_filtered_weight(median_weights$LUAD), "LUAD") +
  buildHeatmap(get_filtered_weight(median_weights$LUSC), "LUSC") +
  buildHeatmap(get_filtered_weight(median_weights$NSCLC), "NSCLC") +
  buildHeatmap(get_filtered_weight(median_weights$GTEx), "GTEx")

draw(all)
```


## Correlation heatmaps
```{r Correlation features, echo = FALSE,  fig.width=7, fig.height=8, fig.align="center", out.width="80%", fig.cap = "Heatmap depicting the correlation of all factors of all models based on feature data. Only significant relations (FDR < 0.01) are shown."}

factor_list <- list("F1-3" = c("factor 1", "factor 2", "factor 3"), "F1" = c("factor 1"))
plots <- lapply(names(factor_list), function(factors_name) {
  factors <- factor_list[[factors_name]]
  weight_mat <- lapply(names(median_weights), function(dataset_id) {
    median_weights[[dataset_id]] %>%
      select(feature, all_of(factors)) %>%
      rename_with(function(x) {
        str_replace(x, "factor", dataset_id)
      }, starts_with("factor")) %>%
      column_to_rownames("feature")
  }) %>% bind_cols()

  cor_res <- rstatix::cor_mat(weight_mat)
  cor_mat <- cor_res %>%
    column_to_rownames("rowname") %>%
    as.matrix()
  cor_pmat <- rstatix::cor_get_pval(cor_res) %>%
    column_to_rownames("rowname") %>%
    as.matrix()

  i <- upper.tri(cor_pmat)
  cor_pmat[i] <- p.adjust(cor_pmat[i], method = "fdr")
  j <- lower.tri(cor_pmat)
  cor_pmat[j] <- p.adjust(cor_pmat[j], method = "fdr")

  svg(
    filename = file.path(params$artifact_dir, "plots", sprintf("%s_factor_correlations.svg", factors_name)),
    width = if_else(factors_name == "F1", 4.5, 7),
    height = if_else(factors_name == "F1", 5, 8)
  )
  corrplot(cor_mat,
    is.corr = TRUE,
    p.mat = cor_pmat,
    sig.level = 0.01,
    insig = "blank", tl.col = "black",
    col = colorRampPalette(rev(rdbu10_palette))(1000),
  )
  dev.off()

  corrplot(cor_mat,
    is.corr = TRUE,
    p.mat = cor_pmat,
    sig.level = 0.01,
    insig = "blank",
    tl.col = "black",
    order = "hclust",
    col = colorRampPalette(rev(rdbu10_palette))(1000),
  )

  write_tsv(
    cor_mat %>% as_tibble(rownames = "factor"),
    file.path(params$artifact_dir, sprintf("%s_factor_correlations.tsv", factors_name))
  )
  write_tsv(
    cor_pmat %>% as_tibble(rownames = "factor"),
    file.path(params$artifact_dir, sprintf("%s_factor_correlation_pvalues.tsv", factors_name))
  )
})
```

### Correlation with immune response

```{r}
# Calculate factors for TRACERx data (Weighted sum of features)
mofa_data_tracerx <- readRDS(file.path(params$features_dir, "mofa_TRACERx.rds"))

tracerx_factors <- lapply(c("JiaSharma", "NSCLC"), function(weights_source) {
  mofa_data_tracerx %>%
    inner_join(median_weights[[weights_source]]) %>%
    mutate(across(starts_with("factor"), ~ .x * value)) %>%
    group_by(sample) %>%
    summarise(across(starts_with("factor"), sum)) %>%
    pivot_longer(cols = -sample, names_to = "factor", values_to = "factor_value") %>%
    mutate(dataset = "TRACERx", weights_source = weights_source)
}) %>% bind_rows()

factors_all <- lapply(names(models), function(dataset_id) {
  get_factor_df(models[[dataset_id]]) %>%
    pivot_longer(cols = -sample, names_to = "factor", values_to = "factor_value") %>%
    mutate(dataset = dataset_id)
}) %>%
  bind_rows() %>%
  bind_rows(tracerx_factors) %>%
  # special labels for tracerx data
  mutate(dataset_label = if_else(is.na(weights_source), dataset, sprintf("%s (%s)", dataset, weights_source)))
```

```{r, fig.width=12, fig.height=18, echo=FALSE, message=FALSE, warning=FALSE}
immresp_all <- feature_data %>%
  filter(view == "immune response", feature == "response") %>%
  rename(`immune response` = value) %>%
  select(sample, `immune response`, dataset)

factors_all %>%
  inner_join(immresp_all) %>%
  ggplot(aes(x = factor_value, y = `immune response`)) +
  geom_point(size = 0.8, color = "#333333") +
  theme_bw() +
  stat_cor() +
  geom_smooth(method = "lm") +
  facet_wrap(dataset_label ~ factor, scales = "free_x", ncol = 7) +
  ylim(c(-2, 3))
```

```{r, fig.height=4, fig.width=4, include=FALSE}
lapply(factors_all$dataset_label %>% unique(), function(dataset_id) {
  factors_all %>%
    inner_join(immresp_all) %>%
    filter(dataset_label == dataset_id, factor == "factor 1") %>%
    rename(`factor 1` = factor_value) %>%
    ggplot(aes(x = `factor 1`, y = `immune response`)) +
    geom_point(size = 0.8, color = "#444444") +
    stat_cor() +
    geom_smooth(method = "lm") +
    theme_cowplot() +
    ylim(c(-2, 3)) +
    ggtitle(dataset_id)
  ggsave(file.path(params$artifact_dir, "plots", sprintf("correlation_f1_immune_response_%s.png", dataset_id)), width = 4, height = 4)
})
```

### Correlation with tumor mutational burden
```{r, fig.height=12, fig.width=12}
factors_all %>%
  inner_join(tmb_all) %>%
  ggplot(aes(x = factor_value, y = `log10(TMB + 1)`)) +
  geom_point(size = 0.8, color = "#333333") +
  theme_bw() +
  stat_cor() +
  geom_smooth(method = "lm") +
  facet_wrap(dataset_label ~ factor, scales = "free_x", ncol = 7)
```

```{r, fig.height=4, fig.width=4, include=FALSE}
lapply(DATASETS, function(dataset_id) {
  factors_all %>%
    inner_join(tmb_all) %>%
    filter(dataset == dataset_id, factor == "factor 1") %>%
    rename(`factor 1` = factor_value) %>%
    ggplot(aes(x = `factor 1`, y = `log10(TMB + 1)`)) +
    geom_point(size = 0.8, color = "#444444") +
    stat_cor() +
    geom_smooth(method = "lm") +
    theme_cowplot() +
    ylim(c(0, 2)) +
    ggtitle(dataset_id)
  ggsave(file.path(params$artifact_dir, "plots", sprintf("correlation_f1_tmb_%s.png", dataset_id)), width = 4, height = 4)
})
```



### Correlation with CD8+ T cell infiltration
```{r, fig.width=16, fig.height=12}
cd8_all <- feature_data %>%
  filter(feature == "CD8 T") %>%
  rename(`CD8 T` = value) %>%
  select(sample, `CD8 T`, dataset)

factors_all %>%
  inner_join(cd8_all) %>%
  ggplot(aes(x = factor_value, y = `CD8 T`)) +
  geom_point(size = 0.8, color = "#333333") +
  theme_bw() +
  stat_cor() +
  geom_smooth(method = "lm") +
  facet_grid(rows = vars(dataset), cols = vars(factor), scales = "free")
```

### Correlate CD8+ T cell infiltration with TMB
```{r, fig.width=16, fig.height=3}
cd8_all %>%
  inner_join(tmb_all) %>%
  ggplot(aes(x = `log10(TMB + 1)`, y = `CD8 T`)) +
  geom_point(size = 0.8, color = "#333333") +
  theme_bw() +
  stat_cor() +
  geom_smooth(method = "lm") +
  facet_wrap(~dataset, scales = "free", ncol = 7) +
  ggtitle("CD8 T vs. TMB")
```

### Correlate CD8+ T cell infiltration with immune response
```{r, fig.width=16, fig.height=3}
immresp_all %>%
  inner_join(tmb_all) %>%
  ggplot(aes(x = `log10(TMB + 1)`, y = `immune response`)) +
  geom_point(size = 0.8, color = "#333333") +
  theme_bw() +
  stat_cor() +
  geom_smooth(method = "lm") +
  facet_wrap(~dataset, scales = "free", ncol = 7) +
  ggtitle("Immune response vs. TMB")
```

### Correlate CD8+ T cell infiltration with TMB
```{r, fig.width=16, fig.height=3}
cd8_all %>%
  inner_join(immresp_all) %>%
  ggplot(aes(x = `immune response`, y = `CD8 T`)) +
  geom_point(size = 0.8, color = "#333333") +
  theme_bw() +
  stat_cor() +
  geom_smooth(method = "lm") +
  facet_wrap(~dataset, scales = "free", ncol = 8) +
  ggtitle("CD8T vs. immune response")
```

### Weight scatter NSCLC / JiaSharma

```{r, fig.width=10, fig.height=7, echo=FALSE, message=FALSE, warning=FALSE}
scatter_data <- bind_rows(lapply(names(median_weights), function(dataset_id) {
  median_weights[[dataset_id]] %>% mutate(dataset = dataset_id)
}))

tmp_scatter_data <- scatter_data %>%
  filter(dataset %in% c("JiaSharma", "NSCLC")) %>%
  select(view, dataset, feature, `factor 1`) %>%
  pivot_wider(names_from = "dataset", values_from = "factor 1")

tmp_scatter_data %>%
  ggplot(aes(x = JiaSharma, y = NSCLC)) +
  geom_smooth(method = lm, color = "black", lty = "dashed", fullrange = TRUE) +
  geom_point(aes(color = view)) +
  geom_label_repel(size = 3.5, data = tmp_scatter_data %>% filter(JiaSharma > 0.5 | NSCLC > 0.5), aes(label = feature)) +
  scale_color_brewer(type = "qual", palette = "Dark2") +
  xlim(c(-1, 1)) +
  ylim(c(-1, 1)) +
  theme_cowplot() +
  background_grid()
```


### Variability of weights between bootstrap samples
```{r, include=FALSE}
all_weights <- lapply(names(bootstrap_models), function(dataset_id) {
  lapply(bootstrap_models[[dataset_id]], get_weight_df) %>%
    bind_rows() %>%
    mutate(dataset = dataset_id)
}) %>%
  bind_rows() %>%
  pivot_longer(cols = c(-feature, -view, -dataset), names_to = "factor", values_to = "factor_weight") %>%
  filter(factor %in% c("factor 1", "factor 2", "factor 3"))
```

```{r, fig.height=40, fig.width=12, echo=FALSE, message=FALSE, warning=FALSE}
all_weights %>% ggplot(aes(x = factor_weight, y = feature)) +
  geom_boxplot(aes(fill = dataset), outlier.size = .5) +
  facet_wrap(~factor, ncol = 3) +
  scale_fill_brewer(type = "qual", palette = "Set2") +
  theme_bw()
```


### Variability of features within and between patients in Jia and Sharma
```{r, fig.width=18, fig.height=20, echo=FALSE, message=FALSE, warning=FALSE}

lapply(c("TRACERx", "JiaSharma"), function(dataset_id) {
  feature_data %>%
    filter(dataset == dataset_id) %>%
    ggplot(aes(x = value, y = patient, color = group)) +
    geom_point(size = .2) +
    facet_wrap(~feature, scale = "free_x") +
    scale_fill_brewer(type = "qual") +
    theme_bw() +
    theme(axis.text.y = element_blank(), axis.ticks.y = element_blank()) +
    ggtitle(dataset_id)
})
```

```{r, include=FALSE}
get_df <- function(df, group) {
  bf <- anovaBF(value ~ patient, data = as.data.frame(df), progress = FALSE) %>% as.vector()
  data.frame(bayes_factor = bf)
}

```


```{r, fig.width=7, fig.height=18, echo=FALSE, message=FALSE, warning=FALSE}

lapply(c("TRACERx", "JiaSharma"), function(dataset_id) {
  bfs <- feature_data %>%
    filter(dataset == dataset_id) %>%
    mutate(patient = as.factor(patient)) %>%
    group_by(feature) %>%
    group_modify(get_df)
  bfs %>%
    mutate(log_bf = log2(bayes_factor)) %>%
    ggplot(aes(y = reorder(feature, -log_bf), x = log_bf)) +
    geom_point() +
    geom_vline(xintercept = 0) +
    geom_vline(xintercept = log2(10), color = "red") +
    theme_bw() +
    ggtitle(dataset_id)
})
```



