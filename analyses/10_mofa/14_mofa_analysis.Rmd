```{r runmofa, echo=FALSE, message=FALSE, results='hide'}
# Train the MOFA model
models = sapply(names(feature_data), function(dataset_id) {
  runMOFA(feature_data[[dataset_id]] %>% select(sample, feature, value, group, view),
          file.path(params$model_dir, paste0(dataset_id, ".hdf5")))
}, simplify=FALSE, USE.NAMES = TRUE)
```

```{r}
lapply(names(models), function(dataset_id) {
  print(dataset_id)
  plotResults(models[[dataset_id]], dataset_id)
})
```

### Run MOFA on bootstrap models

```{r}
bootstrap_models = BiocParallel::bplapply(names(bootstrap_datasets), function(dataset_id) {
  lapply(1:N_BOOTSTRAP, function(i) {
    runMOFA(
      bootstrap_datasets[[dataset_id]][[i]] %>% select(sample, feature, value, group, view) ,
      paste0(
        params$model_dir,
        paste0(dataset_id, "_boot_", stringr::str_pad(i, 3, pad = "0"), ".hdf5")
      )
    )
  })
})
names(bootstrap_models) = names(bootstrap_datasets)

save(models, bootstrap_datasets, bootstrap_models, file="./tmp_mofa.rda")
```



```{r, fig.width=15, fig.height=20}
all <- buildHeatmap(models$Jia2018, "Jia") + 
  buildHeatmap(models$Sharma2019, "Sharma") + 
  buildHeatmap(models$JiaSharma, "J+S") +
  buildHeatmap(models$LUAD, "LUAD") +
  buildHeatmap(models$LUSC, "LUSC") +
  buildHeatmap(models$NSCLC, "NSCLC") +
  buildHeatmap(models$GTEx, "GTEx")

# + buildHeatmap(features$FEAT.comb.jiasharma) + buildHeatmap(features$FEAT.luad)+buildHeatmap(features$FEAT.lusc) + buildHeatmap(features$FEAT.nsclc) + buildHeatmap(features$FEAT.crc)+buildHeatmap(features$FEAT.skcm) + buildHeatmap(features$FEAT.pbmc) + plotHMs_bootstrap(jiasharma,"J+S") + plotHMs_bootstrap(nsclc,"NSCLC") 

draw(all)

```


```{r Correlation features, echo = FALSE,  fig.width=10, fig.height=12, fig.align="center", out.width="80%", fig.cap = "Heatmap depicting the correlation of all factors of all models based on feature data. Only significant relations (p<0.001) are shown."}

# corr.feat <- getCorr(models)

 
```


