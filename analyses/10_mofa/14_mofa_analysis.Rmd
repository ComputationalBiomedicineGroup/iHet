---
title: MOFA analysis results
params:
  nxfvars:
    value:
      data_dir: "../../results/10_mofa/13_run_mofa"
      features_dir: "../../results/10_mofa/12_prepare_mofa_data/datasets"
      easier_dir: "../../results/10_mofa/11_easier"
      out_dir: "/local/scratch/sturm/mofa"
---


```{r setup, include=FALSE, message=FALSE}
options(bitmapType = "cairo")
nxfvars <- params$nxfvars
message(capture.output(str(nxfvars)))
knitr::opts_chunk$set(echo = TRUE, dpi = 300, dev = "png", fig.path = "figures/")
source("helper_functions.R")
library(readr)
DATASETS <- c("Jia", "Sharma", "LUAD", "LUSC", "GTEx", "JiaSharma", "NSCLC")
PATHWAYS_OF_INTEREST <- c("JAK-STAT", "VEGF", "PI3K", "NFkB", "Trail", "TNFa")
TFS_OF_INTEREST <- c("SPI1", "NFKB1", "STAT1", "MYC", "E2F4", "E2F2", "ZNF263")
gtex_easier <- readRDS(file.path(nxfvars$easier_dir, "GTEx_expr_data.features.rds"))
nsclc_easier <- readRDS(file.path(nxfvars$easier_dir, "NSCLC_expr_data_sel.features.rds"))
features_jiasharma <- readRDS(file.path(nxfvars$features_dir, "JiaSharma.rds"))
```

```{r, include=FALSE}
models <- sapply(DATASETS, function(dataset_id) {
  load_model(file.path(nxfvars$data_dir, sprintf("%s.hdf5", dataset_id)))
}, simplify = FALSE, USE.NAMES = TRUE)

bootstrap_models <- sapply(DATASETS, function(dataset_id) {
  lapply(Sys.glob(file.path(nxfvars$data_dir, sprintf("boot_%s_*.hdf5", dataset_id))), function(x) {
    load_model(x)
  })
}, simplify = FALSE, USE.NAMES = TRUE)
```
## Variance Plots
```{r, results='hide', echo=FALSE}
lapply(names(models), function(dataset_id) {
  print(dataset_id)
  plotResults(models[[dataset_id]], dataset_id)
})
```
```{r, include=FALSE}

#' extract and preprocess weights from a MOFA model
get_weight_df <- function(model) {
  weights <- get_weights(model, scale = TRUE)
  # Rotate factors such that they are positively associated with CD8+ T-cell infiltration.
  rotation <- diag(sign(weights[["Immune cells quantification"]]["CD8 T", ]))
  lapply(names(weights), function(modality) {
    weights[[modality]] %*% rotation %>%
      as_tibble(rownames = "feature") %>%
      mutate(view = modality) %>%
      rename_with(function(x) {
        str_replace(x, "V", "factor ")
      }, starts_with("V"))
  }) %>%
    bind_rows() %>%
    arrange(view, feature)
}
```


```{r, include=FALSE}
median_weights <- sapply(names(bootstrap_models), function(dataset_id) {
  lapply(bootstrap_models[[dataset_id]], get_weight_df) %>%
    bind_rows() %>%
    group_by(view, feature) %>%
    summarise_all(median) %>%
    ungroup()
}, USE.NAMES = TRUE, simplify = FALSE)
```


## Heatmap of factors


```{r, fig.width=15, fig.height=20, echo=FALSE, message=FALSE, warning=FALSE}
all <- buildHeatmap(get_weight_df(models$Jia), "Jia") +
  buildHeatmap(get_weight_df(models$Sharma), "Sharma") +
  buildHeatmap(get_weight_df(models$JiaSharma), "J+S") +
  buildHeatmap(get_weight_df(models$LUAD), "LUAD") +
  buildHeatmap(get_weight_df(models$LUSC), "LUSC") +
  buildHeatmap(get_weight_df(models$NSCLC), "NSCLC") +
  buildHeatmap(get_weight_df(models$GTEx), "GTEx")

draw(all)
```

## Heatmap of bootstrapped factors
```{r, fig.width=15, fig.height=8, echo=FALSE, message=FALSE, warning=FALSE}
get_filtered_weight <- function(model) {
  model %>%
    filter((feature %in% PATHWAYS_OF_INTEREST) | (feature %in% TFS_OF_INTEREST) | (view == "Immune cells quantification"))
}

all <- buildHeatmap(get_filtered_weight(median_weights$Jia), "Jia") +
  buildHeatmap(get_filtered_weight(median_weights$Sharma), "Sharma") +
  buildHeatmap(get_filtered_weight(median_weights$JiaSharma), "J+S") +
  buildHeatmap(get_filtered_weight(median_weights$LUAD), "LUAD") +
  buildHeatmap(get_filtered_weight(median_weights$LUSC), "LUSC") +
  buildHeatmap(get_filtered_weight(median_weights$NSCLC), "NSCLC") +
  buildHeatmap(get_filtered_weight(median_weights$GTEx), "GTEx")

draw(all)
```


```{r, fig.width=15, fig.height=20, echo=FALSE, message=FALSE, warning=FALSE}
all <- buildHeatmap(median_weights$Jia, "Jia") +
  buildHeatmap(median_weights$Sharma, "Sharma") +
  buildHeatmap(median_weights$JiaSharma, "J+S") +
  buildHeatmap(median_weights$LUAD, "LUAD") +
  buildHeatmap(median_weights$LUSC, "LUSC") +
  buildHeatmap(median_weights$NSCLC, "NSCLC") +
  buildHeatmap(median_weights$GTEx, "GTEx")

draw(all)
```

## Correlation heatmaps
```{r Correlation features, echo = FALSE,  fig.width=10, fig.height=12, fig.align="center", out.width="80%", fig.cap = "Heatmap depicting the correlation of all factors of all models based on feature data. Only significant relations (FDR < 0.01) are shown."}

weight_mat <- lapply(names(median_weights), function(dataset_id) {
  median_weights[[dataset_id]] %>%
    select(feature, `factor 1`, `factor 2`, `factor 3`) %>%
    rename_with(function(x) {
      str_replace(x, "factor", dataset_id)
    }, starts_with("factor")) %>%
    column_to_rownames("feature")
}) %>% bind_cols()

cor_res <- rstatix::cor_mat(weight_mat)
cor_mat <- cor_res %>%
  column_to_rownames("rowname") %>%
  as.matrix()
cor_pmat <- rstatix::cor_get_pval(cor_res) %>%
  column_to_rownames("rowname") %>%
  as.matrix()

i <- upper.tri(cor_pmat)
cor_pmat[i] <- p.adjust(cor_pmat[i], method = "fdr")
j <- lower.tri(cor_pmat)
cor_pmat[j] <- p.adjust(cor_pmat[j], method = "fdr")

corrplot(cor_mat,
  is.corr = TRUE,
  p.mat = cor_pmat,
  sig.level = 0.01,
  insig = "blank", tl.col = "black"
)


corrplot(cor_mat,
  is.corr = TRUE,
  p.mat = cor_pmat,
  sig.level = 0.01,
  insig = "blank",
  tl.col = "black",
  order = "hclust"
)

write_tsv(cor_mat %>% as_tibble(rownames = "factor"), file.path(nxfvars$out_dir, "factor_correlations.tsv"))
write_tsv(cor_pmat %>% as_tibble(rownames = "factor"), file.path(nxfvars$out_dir, "factor_correlation_pvalues.tsv"))
```

### Correlation with immune response
```{r, fig.width=8, fig.height=3, echo=FALSE, message=FALSE, warning=FALSE}
immrep_all <- nsclc_easier$immresp
immrep_all[["GTEx"]] <- gtex_easier$immresp[["Lung"]]
immrep_all[["Jia"]] <- immrep_all[["Jia2018"]]
immrep_all[["Sharma"]] <- immrep_all[["Sharma2019"]]
immrep_all[["Jia2018"]] <- NULL
immrep_all[["Sharma2019"]] <- NULL
immrep_all[["JiaSharma"]] <- bind_rows(immrep_all[["Jia"]], immrep_all[["Sharma"]])
immrep_all[["NSCLC"]] <- bind_rows(immrep_all[["LUAD"]], immrep_all[["LUSC"]])

plot_correlation <- function(dataset_id) {
  get_factors(models[[dataset_id]]) %>%
    lapply(function(x) {
      x[, 1:3]
    }) %>%
    do.call("rbind", .) %>%
    as.data.frame() %>%
    as_tibble(rownames = "patient") %>%
    pivot_longer(cols = -patient, names_to = "factor", values_to = "factor_value") %>%
    inner_join(immrep_all[[dataset_id]] %>% as_tibble(rownames = "patient")) %>%
    ggplot(aes(x = factor_value, y = response)) +
    geom_point() +
    facet_wrap(~factor, scale = "free_x") +
    theme_cowplot() +
    stat_cor() +
    geom_smooth(method = "lm") +
    ggtitle(dataset_id)
}

lapply(DATASETS[1:6], plot_correlation)
```

### Weight scatter NSCLC / JiaSharma

```{r, fig.width=10, fig.height=8, echo=FALSE, message=FALSE, warning=FALSE}
scatter_data <- bind_rows(lapply(names(median_weights), function(dataset_id) {
  median_weights[[dataset_id]] %>% mutate(dataset = dataset_id)
}))

tmp_scatter_data <- scatter_data %>%
  filter(dataset %in% c("JiaSharma", "NSCLC")) %>%
  select(view, dataset, feature, `factor 1`) %>%
  pivot_wider(names_from = "dataset", values_from = "factor 1")

tmp_scatter_data %>%
  ggplot(aes(x = JiaSharma, y = NSCLC)) +
  geom_smooth(method = lm, color = "black", lty = "dashed") +
  geom_point(aes(color = view)) +
  geom_label_repel(data = tmp_scatter_data %>% filter((view == "Immune cells quantification") | abs(JiaSharma) > 0.5 | abs(NSCLC) > 0.5), aes(label = feature)) +
  theme_bw() +
  scale_color_brewer(type = "qual", palette = "Dark2")
```


### Variability of weights between bootstrap samples
```{r, include=FALSE}
all_weights <- lapply(names(bootstrap_models), function(dataset_id) {
  lapply(bootstrap_models[[dataset_id]], get_weight_df) %>%
    bind_rows() %>%
    mutate(dataset = dataset_id)
}) %>%
  bind_rows() %>%
  pivot_longer(cols = c(-feature, -view, -dataset), names_to = "factor", values_to = "factor_weight") %>%
  filter(factor %in% c("factor 1", "factor 2", "factor 3"))
```

```{r, fig.height=40, fig.width=12, echo=FALSE, message=FALSE, warning=FALSE}
all_weights %>% ggplot(aes(x = factor_weight, y = feature)) +
  geom_boxplot(aes(fill = dataset), outlier.size = .5) +
  facet_wrap(~factor, ncol = 3) +
  scale_fill_brewer(type = "qual", palette = "Set2") +
  theme_bw()
```


### Variability of features within and between patients in Jia and Sharma
```{r, fig.width=18, fig.height=15, echo=FALSE, message=FALSE, warning=FALSE}
features_jiasharma %>%
  ggplot(aes(x = value, y = patient, fill = group)) +
  geom_boxplot() +
  facet_wrap(~feature, scale = "free_x") +
  scale_fill_brewer(type = "qual") +
  theme_bw() +
  theme(axis.text.y = element_blank(), axis.ticks.y = element_blank())
```

```{r, include=FALSE}
get_df <- function(df, group) {
  bf <- anovaBF(value ~ patient, data = as.data.frame(df), progress = FALSE) %>% as.vector()
  data.frame(bayes_factor = bf)
}

bfs <- features_jiasharma %>%
  mutate(patient = as.factor(patient)) %>%
  group_by(feature) %>%
  group_modify(get_df)
```


```{r, fig.width=7, fig.height=18, echo=FALSE, message=FALSE, warning=FALSE}
bfs %>%
  mutate(log_bf = log2(bayes_factor)) %>%
  ggplot(aes(y = reorder(feature, -log_bf), x = log_bf)) +
  geom_point() +
  geom_vline(xintercept = 0) +
  geom_vline(xintercept = log2(10), color = "red") +
  theme_bw()
```


