---
params:
  data_dir: "../../results/10_mofa/11_easier"
  model_dir: "../../results/10_mofa/12_mofa_analysis"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,dpi=300,dev = "png",fig.path='figures/')
source('helper_functions.R')
DATASETS = c("Jia2018", "Sharma2019", "LUAD", "LUSC", "GTEx")
```



```{r loaddata}
gtex_data = readRDS(file.path(params$data_dir, "GTEx_easier.rds"))
nsclc_data = readRDS(file.path(params$data_dir, "NSCLC_easier.rds"))
data_all = nsclc_data
for(slot in names(gtex_data)) {
  data_all[[slot]][["GTEx"]] = gtex_data[[slot]][["Lung"]]
}
```


```{r processfeatures}
feature_data = sapply(DATASETS, function(dataset_id) {
  processFeatures(data_all, dataset_id) 
}, simplify = FALSE, USE.NAMES = TRUE)

feature_data$JiaSharma = bind_rows(feature_data$Jia2018, feature_data$Sharma2019)
feature_data$NSCLC = bind_rows(feature_data$LUAD, feature_data$LUSC) %>% mutate(group = "NSCLC")
```

```{r}
for (feature in unique(feature_data$Jia2018$view)){
  generateHeatmap(feature_data$Jia2018 %>% filter(view == !!feature), feature, row_names=TRUE)
}
```


```{r runmofa, echo=FALSE, message=FALSE, results='hide'}
# Train the MOFA model
models = sapply(names(feature_data), function(dataset_id) {
  runMOFA(feature_data[[dataset_id]], file.path(params$model_dir, paste0(dataset_id, ".hdf5")))
}, simplify=FALSE, USE.NAMES = TRUE)
```

```{r}
lapply(names(models), function(dataset_id) {
  print(dataset_id)
  plotResults(models[[dataset_id]], dataset_id)
})
```
### Bootstrapping analysis
```{r}

N_BOOTSTRAP=100
bootstrap_datasets = sapply(DATASETS, function(dataset_id) {
  
}, simplify = FALSE, USE.NAMES = TRUE)

```




```{r, fig.width=15, fig.height=20}
all <- buildHeatmap(models$Jia2018, "Jia") + 
  buildHeatmap(models$Sharma2019, "Sharma") + 
  buildHeatmap(models$JiaSharma, "J+S") +
  buildHeatmap(models$LUAD, "LUAD") +
  buildHeatmap(models$LUSC, "LUSC") +
  buildHeatmap(models$NSCLC, "NSCLC") +
  buildHeatmap(models$GTEx, "GTEx")

# + buildHeatmap(features$FEAT.comb.jiasharma) + buildHeatmap(features$FEAT.luad)+buildHeatmap(features$FEAT.lusc) + buildHeatmap(features$FEAT.nsclc) + buildHeatmap(features$FEAT.crc)+buildHeatmap(features$FEAT.skcm) + buildHeatmap(features$FEAT.pbmc) + plotHMs_bootstrap(jiasharma,"J+S") + plotHMs_bootstrap(nsclc,"NSCLC") 

draw(all)

```


```{r Correlation features, echo = FALSE,  fig.width=10, fig.height=12, fig.align="center", out.width="80%", fig.cap = "Heatmap depicting the correlation of all factors of all models based on feature data. Only significant relations (p<0.001) are shown."}

# corr.feat <- getCorr(models)

 
```




